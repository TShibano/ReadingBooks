# GitLabについて

* "GitLab実践ガイド"(2017年12月情報)を元に作成したため、情報が古い部分があると考えられる。
    * 最新の情報を取得して、更新していきたい。


## 参考文献

* GitLab実践ガイド DevOpsワークフローの導入と運用

## GitLabが目指す開発スタイル

### アプリケーションの開発スタイル

アプリケーションの開発は主に4つのフェーズから成り立っている。
1. 開発ワークフロー: Outputはソースコード
    1. アイデア
    2. 課題
    3. 計画
    4. コード
2. 継続的インテグレーション(CI): Outputは確実に動作する成果物
    1. ビルド
    2. テスト
    3. ビュー
3. 継続的デプロイ(CD): Outputは成果物の安定的なデプロイ
    1. ステージング
    2. リリース
4. フィードバック: 改善プロセス
    1. フィードバック

ライフサイクルの各工程を支える開発ツールが存在しており、それらによってDevOpsが実現されている。
一方で、GitLabは、このライフサイクル全体を一元管理することが出来る。
つまり、ツールの維持管理にかかる時間を短縮し、開発者がコード作成に時間を費やすことによって、ビジネスアジリティを向上させることができる。

### DevOps
DevOpsとは、プロジェクトを成功させるために、組織文化とツールの両面を改善することで、
ビジネスアジリティ(敏捷性)を向上させ、リスクを低減する活動。
組織文化とは、メンバのアイデアを素早くビジネスに展開するためのコラボレーションであり、
ツールとは、継続的改善を実現し、品質を上げ、リスクを低減する開発ツールである。

### ConvOps
GitLabは、DevOpsを実施するための開発スタイルとして、ConvDev(Conversational Development)を提唱している。
ConvDevとは、全メンバがアイデアから展開までのコラボレーションと知識共有を促進し、開発ライフサイクルを加速することである。
ConvDevを実現するためには、
現状の課題を洗い出し、チーム間で共通の目標(KPI)とタスクの優先順位を共有した上で、チーム内外の多様性を受け入れてコミュニティへの帰属意識を高めた上で、
ロードマップを定義する。


## GitLabとは

### GitLabの主な機能

* 統合的なコード管理
* 課題とリリースの追跡
* アプリコードの品質向上
* アプリデプロイ管理
* 更新のモニタリング

### GitLabのアーキテクチャ

基本アーキテクチャとしては、「Nginx-Unicorn-PostgrSQL」のWeb3層構造である。
詳細は省略するが、複数のコンポーネントが複雑に連携しあっている。

* 主要ミドルウェア
    * Nginx
    * Unicorn
    * PostgreSQL
    * Sidekiq
    * Redis
* 主要アプリケーション
    * GitLab-Rails
    * GitLab-Shell
    * GitLab-Workhorse
    * Gitaly

## GitLabの運用

### インストール

Omnibusパッケージのインストールが推奨されている。
面倒な設定をせずとも簡単にインストールができる。
詳細は公式サイトを参照。
Dockerコンテナも存在するが、大規模環境には向ていないので注意が必要である。

### 運用管理

管理コマンド
* `gitlab-ctl`
    * プロセス管理や設定の再構成、ログ確認を一元的に操作できるコマンド
* `gitlab-psql`
    * PostgreSQLへ接続するためのコマンド
* `gitlab-rake`
    * Rubyで実装された既定のビルドツールを実行するためのコマンド
    * バックアップの取得やリストアが可能である。

### GitLabを利用する準備

* ユーザ管理
    * 管理者による作成 or 自身による作成
    * SSH Keyの登録を行う
* グループ管理
    * ユーザをグループにまとめて管理することができる
* プロジェクト管理
    * GitリポジトリやWikiなど、GitLabに保存するコンテンツはすべてプロジェクト単位で取り扱われる
    * ユーザプロジェクトとグループプロジェクトがある

## 開発ワークフロー

### アイデアの共有: GitLab Mattermost

Mattermostというオープンソースのチャットツールを活用できる。
OmnibusパッケージにGitLab Mattermostが含まれており、同一サーバ上にインストールすることが出来る。
GitLabと連携することで、チャットだけでなく、GitLab上のイベントをGitLab Mattermost上に通知することができる。

### 課題の管理と開発管理: Issue Tracker/Issue Board

チケット管理システムとして、Issue Trackerがある。
タスクの整理や課題やタスクの一元管理、レポーティングと共有が可能である。
まず、マイルストーンとラベルを準備したうえで、課題チケット(Issue)を作成する。

チケット駆動開発(TiDD: Ticket-Driven Development)とは、
プロジェクトの各タスクをチケットに割り当てながら、開発ワークフローを管理していくスタイルのことである。
No Ticket, No Commit。
作業に取り掛かるときは、まずチケットを起票する。

### 開発フローとコード管理: Merge Request/GitLab Flow

マージリクエスト(Merge Request)とは、リモートリポジトリのブランチにプッシュした内容をメンバに知らせて、
レビューを行ってもらうためのチケット機能であり、コミュニケーションの場でもある。
レビュープロセスを通過することで、品質を担保することができる。
保護ブランチワークフローとフォークワークフローがある。
社内では、開発手順やリポジトリ構造が単純な保護ブランチワークフローが推奨される。
一方で、オープンソース開発で不特定多数の開発者にリポジトリへの書き込み権限を与えないために、フォークワークフローが行われる。

Merge Requestのコミュニケーション機能
* WIP(Work In Progress)
* Merge Conflict
* Auto Close Issues

ブランチの作成方法にはいくつかの戦略がある。

* GitHub Flow
* GitLab Flowの環境ブランチ戦略
* GitLab Flowのリリースブランチ戦略


## 継続的インテグレーション

### 継続的なビルドとテストの実施

継続的インテグレーション導入することで下記のメリットが得られる
* 品質保持
* 作業コストの削減
* 継続的な分析と改善

GitLabには、ビルドやテスト機能が付随していないが、**GitLab CI/CD** のジョブ機能を用いることで、
ビルドツールやテストツールと連携したインテグレーションの自動化が可能である。
GitLab CI/CDは、`.gitlab-ci.yml`という設定ファイルにジョブを定義した上で、GitLab Runnerを実行することで、ビルド等を行う。
GitLab CI/CDには以下のような特徴がある。

* マルチプラットフォーム
* Merge Requestとの連携
* 並列分散実行
* ロギング機能
* オートスケール
* アーティファクトの管理


## 継続的デプロイ

安定的なサービスリリースを行うためには、いかに環境の差異をなくし、動的なデプロイメントを実現するかが重要になる。

### デプロイメントパイプライン
**デプロイメントパイプライン**とは、
ビルド・単体テスト・デプロイメント・機能テスト・サービスリリース、という各ステージをに対して、全体を通した自動化を行う実装のことである。

デプロイパイプラインを実装するためには、**GitLab CI/CD Pipeline**が用いられる。
開発ワークフローやブランチ戦略によって、最適なデプロイパイプラインを構築する必要がある。
`.gitlab-ci.yml`内のジョブをステージに分けて編集する。

**Review Apps**とは、レビュー環境を動的に構築する機能である。
`.gitlab-ci.yml`を編集する。

## フィードバック

システムとビジネスの2つの観点からフィードバックを行うことが、安定的な継続的デリバリの実現には欠かせない。

### システムのパフォーマンス測定

**GitLab Prometeus**とは、サービスの状態監視やパフォーマンス測定ツールである。
GitLabサーバの稼働状況や、GitLab CI/CDでデプロイした環境のパフォーマンスを測定してくれる。

### アイデアからビジネスへ

DevOpsの改善サイクルでは、アイデアが閃いてからビジネスアプリケーションを展開するまでのパイプラインを迅速化することが重要である。
その中でも特に、開発メンバ同士で行う、課題の擦り合わせや承認プロセスに要するコミュニケーション工数は、注目すべき改善指標である。
チームとして最適な開発工数を目指すために、デプロイメントパイプライン工数を可視化する機能として、以下2つがある。

* Cycle Analytics
    * Git+ab Flowの開発プロセスに基づいて各ステージの時間を追跡することが可能
* ConvDev Index
    * アプリケーションを作るうえで必要な各機能の利用率を測定する。

さらに、プラットフォーム自体の管理工数を減らすために、**Auto DevOps**という考え方があり、GitLabの注目すべき機能である。
Auto DevOpsとは、DevOpsプロジェクトを容易に実現するための機能であり、CI/CDプラットフォームがセットアップされた状態ですぐに利用することができる。



## その他

* ツールを入れただけで効率的な開発ワークフローが出来、コストが下がることはない。
    * コミュニケーションを活性化させ、日々改善していくことが開発ワークフローの効率化につながる
    * そのためにも、気軽にコミュニケーションをとれる場を作り出し、作業の見えるかを徹底することが重要。