# おうちで学べるデータベースのきほん

## Chapter01 データベースって何だろう

* 現代はあらゆるものがデータベース化され、データが蓄積されている
* データベースの基本機能
    * データの検索と更新(登録・修正・削除)
    * 同時実行制御: 複数ユーザによる更新の整合性の確保
    * 耐障害性: 壊れにくく、壊れても復旧が可能
    * セキュリティ: データベースをいかに上手く隠すか
* データベースの種類
    * 階層型データベース: 階層構造で管理。
    * リレーショナルデータベース: 二次元表で管理
    * オブジェクト指向データベース: オブジェクトで管理
    * XMLデータベース: XML形式で管理
    * NoSQLデータベース: Not Only SQL

## Chapter02 リレーショナルデータベースって何だろう

リレーショナルデータベース(Relational DataBase; RDB)は、下記の特徴を持つ。
* リレーション、つまり二次元表を使って管理する
* SQL(Structured Query Language)によるデータの操作が非常に簡単である
    * SELECT: 検索コマンド
    * INSERT: 登録コマンド
    * UPDATE: 更新コマンド
    * DELETE: 削除コマンド

データベースを実現するための具体的なソフトウェアのことを、DBMS(DataBase Management System)という。
DBMSには、OracleやMySQL、PostgresSQLなどがある。

実際のシステムは、OSとミドルウェアとアプリケーションの3階層のソフトウェアを組み合わせて作られる。
OSとは、システムが動作するための一番の土台となる機能を提供するソフトウェアである。
ミドルウェアとは、OSとアプリケーションの間で動くソフトウェアのことである。
データベースはミドルウェアに属するソフトウェアである。
アプリケーションとは、業務的な機能を持つようプログラムされたソフトウェアである。
ユーザが最も頻繁に触るソフトウェアである。

OSとデータベースは、予算や機能、開発者・運用者のスキルによって組み合わせて使用する。
データベースとアプリケーションの関係性としては、アプリケーションがユーザとデータベースの間に入っているのが重要である。
つまり、ユーザがアプリケーションを介してデータベースにアクセスするということであり、これはセキュリティやシステム開発の点で利点がある。


## Chapter03 データベースにまつわるお金の話

イニシャルコストとランニングコストがかかる。
イニシャルコストは、エディションとオプションによって増減がある。
ランニングコストは、サポート料である。何かしらの問題が起きた時の責任の分散になる。

コストは、イニシャルコストとランニングコストの両方を含めたトータルコストで考える癖をつけるのが重要である。

## Chapter04 データベースとアーキテクチャ構成

アーキテクチャとは、構成という意味であり、
システムを作り上げるための物理レベルの組合せという意味である。

アーキテクチャの設計は、サーバやOS、他のミドルウェアに加えネットワーク機器などの知識が必要で非常に難しい。
一方で、アーキテクチャ設計が出来なければ、システム構築にかかるコストを算出できないため、アーキテクチャ設計は非常に重要である。

### DBのアーキテクチャの歴史

1. スタンドアロン
    1. ネットワークに接続されておらず、単独で動作するマシン
    2. 利点は、構築が簡単で、セキュリティは高い
    3. 欠点は、離れた場所から作業付加、複数ユーザの同時作業不可、可用性が低い、拡張性が乏しい。
2. クライアント/サーバ(クラサバ)
    1. DBサーバ1台に対して、複数のユーザ端末がアクセスするタイプの構成
    2. 欠点は、インターネットから直接DBにアクセス出来るセキュリティリスクと多数のユーザのクライアント上でアプリケーションを管理するコストが高いこと
3. Web3層
    1. Webサーバ層・アプリケーション層・データベース層
    2. クライアントとDBサーバの間にWebサーバ層とアプリケーション層が追加された。
    3. これにより、クラサバのセキュリティリスクと管理コストを改善

### 可用性と拡張性の確保

* 可用性(Availabity): 障害なくサービスを継続できる程度を表す概念
    * 心臓戦略: 高品質-少数戦略。
    * 腎臓戦略: 低品質-多数路線。クラスタリング(同じ機能を持つ構成を並列化させること)->冗長化。
        * 収穫逓減の法則: 数を増やせば増やすほど、1つあたりから得られる効果が減ること。
        * 単一障害点(SPOF; Single Point of Failure): 全体の強度は最も弱いところの強度で決まる
* 拡張性(Scalability): 必要に応じて機能をどの程度向上させられることができるのかを表す概念

* 信頼性: システムを構成するコンポーネントの故障率

### DBサーバの冗長化: クラスタリングとレプリケーション

DBサーバはデータを永続的に貯める必要があり、かつパフォーマンスを求められる。
実際は、専用の外部ストレージとセットでDBサーバのアーキテクチャは考える。
大きく、クラスタリングとレプリケーションの二つがある。

* クラスタリング: DBサーバのみを冗長化する
  * シェアードナッシング: DBサーバとストレージのセットを増やし、並列処理を行うことで、パフォーマンスを上げる。カバーリング等が必要になる
  * シェアードディスク: 複数のDBサーバが1つのストレージを共有している(ストレージがボトルネックになることも)
    * Active-Active構成: DBサーバが同時稼働している
      * 1つのDBサーバがダウンしても、システムは継続できる
      * CPUやメモリが増えるため、パフォーマンスの向上も見込める
    * Active-Standby構成: アクティブ型以外のDBサーバは待機している
      * Hot-Standby: 常にDBサーバは起動され、トラブル時に切り替わる
      * Cold-Standby: 普段は起動されており、トラブル時に起動して、切り替わる
* レプリケーション: DBサーバとデータを冗長化する
  * マスタスレーブ: 元になるDBをマスタ、同期される側をスレーブ。
  * マルチマスタ: マスタが2つある構成。あまり見かけない。


## Chapter5 DBMSを操作する際の基本知識

MySQLのインストール方法は省略

DBMSを使う際にはまずコネクションを確立させる必要がある。
それはログインをするようなもの。
データベースには、SQL以外にもコマンドを入力することができる。
一般的なものはなくて、DBMS独自に存在する。

### リレーショナルデータベースの階層
データベースは3 or 4つの階層からなる。
* インスタンス
  * 実際にOS上に存在するプロセス
* データベース
  * 階層の一つである
* スキーマ
  * ディレクトリのようなものである
* テーブル(オブジェクト)
  * テーブル以外にも、インデックスやストアドプロシージャなど、総称してオブジェクトが保存される

ただし、DBMSによっては、データベースがなく、3層になっている場合もある。
ANSIの標準SQLによると、4層が正確である。


## Chapter06 SQL文の基本を学ぼう

```
SELECT DISTINCT xxx FROM db1.table1 WHERE yyy='hoge';
```
db1というデータベースのtable1テーブルから(FROM db1.table1)、yyy列が'hoge'である行のうち(WHERE yyy='hoge')、xxx列のみを重複なし(DISTINCT)で抽出する(SELECT xxx\)。

### よく使うSQLコマンド(SELECT文)

* `SELECT (DISTINCT) column1`
  * (重複行を省いて)列を選ぶ
* `FROM db1.table1`
  * データベースDBのtable1というテーブルを選ぶ
* `WHERE col1='hoge' AND col2>100`
  * 条件に合致する行を抽出する
* `GROUP BY xxx`
  * グループに分ける
* `COUNT(), MIN(), MAX(), SUM(), AVG()`
  * 関数を用いて集約する
* `GROUP_CONCAT`
  * 文字列を集約する
* `HAVING yyy`
  * グループ毎に集約した値を条件にしたい場合に使用する
* `ORDER BY xxx (DESC)`
  * xxxを基準に並び替える．
  * DESCがある場合，降順になる．

SELECTを使うSQL文は，必ず次の順番で記述する必要がある．
1. `SELECT`
2. `FROM`
3. `WHERE`
4. `GROUP BY`
5. `HAVING`
6. `ORDER BY`

### データの更新・挿入・削除
* `UPDATE table1 SET col1=xxx, col2=yyy WHERE 条件;`
  * データを更新する
* `INSERT INTO table1 (col1, col2) VALUES (val1, val2);`
  * データを挿入する
  * 列名は記述しなくても良いが，その場合，値は列の順番通りに設定する必要がある
  * 列と値はすべてえ記入しなくてもよく，その場合はデフォルト値が入る
  * テーブルや列の情報は，`SHOW CREATE TABLE table1`や`DESC table1`で確認できる
* `DELETE FROM table1 WHERE 条件`
  * データを削除する

並び替え(`ORDER BY`)や集約(`MAX(xxx)`, `COUNT(*)`)、グループ分け(`GROUP BY`)等も行う事が出来る。


### ビューの作成と副問い合わせ、結合

ビュー(view)は、テーブルと同じように扱えるが、テーブルのようにデータは持たずに、テーブルに対する`SELECT`をもっている。
次のような利点がある。

1. 複雑なSELECT文をいちいち毎回記述する必要がなくなる
2. 必要な列、行だけをユーザに見せることができ、更新時にもビュー定義に沿った更新に限定することができる
3. 1と2の利点をデータ格納なしに実現でき、ビューを削除しても参照しているテーブルは影響を受けない

`CREATE VIEW VIEW_NAME col1 col2 AS SELECT 文;`


副問い合わせ(サブクエリ)とは、`SELECT`の結果1つの列と1行からなるテーブル、つまり単一の値のことである。
副問い合わせは、テーブルのように扱ったり、数値のように扱って条件分に利用したりできる。

結合(join)とは、あるテーブルに別のテーブルの列を持ってくる操作のことである。
この時、行を合わせるための条件を「結合条件」という。
結合の仕方には複数あるが、ここでは**内部結合**(inner join)と**外部結合**(outer join)を述べる。

* 内部結合
    * 結合条件に一致する行のみを2つのテーブルから持ってくる
    * `SELECT 選択したい列のリスト FROM table1 INNER JOIN table2 ON 結合条件`
* 外部結合
    * 指定したテーブルを基準にしてすべての行を表示し、もう一方のテーブルは値があれば表示する
    * `SELECT 選択したい列のリスト FROM table1 LEFT OUTER JOIN table2 on 結合条件`


## Chapter07 トランザクションと同時実行制御 ~複数のクエリをまとめる~


## Chapter08 テーブル設計の基礎 ~テーブルの概念と正規形~


## Chapter09 バックアップとリカバリ ~障害に備える仕組み~


## Appendix パフォーマンスを考えよう ~性能を向上させるために~